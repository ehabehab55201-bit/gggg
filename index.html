<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ QR Ù…Ø´ÙÙ‘Ø± (Local)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:#0b1220;color:#e8eefc}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    h1{margin:0 0 12px;font-size:22px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1050px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:#121a2b;border:1px solid #22304e;border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:10px 0 6px;color:#c9d6ff;font-size:13px}
    input,select,textarea{
      width:100%;box-sizing:border-box;background:#0b1220;color:#e8eefc;
      border:1px solid #22304e;border-radius:12px;padding:10px 12px;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.row{grid-template-columns:1fr 1fr}}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:0;border-radius:12px;padding:10px 14px;cursor:pointer;
      background:#2b65ff;color:white;font-weight:700
    }
    button.secondary{background:#26324f}
    button.danger{background:#ff3b3b}
    button.ok{background:#1fbf75}
    .hint{opacity:.85;font-size:12px;margin-top:10px;line-height:1.7}
    .qrbox{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
    #qr{background:white;border-radius:12px;padding:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
    .status{margin-top:10px;padding:10px;border-radius:12px;border:1px dashed #22304e;background:#0b1220}
    .okBorder{border-color:#1fd17a}
    .badBorder{border-color:#ff7777}
    .small{font-size:12px;opacity:.95}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #22304e;font-size:12px}
    .tableWrap{overflow:auto;border:1px solid #22304e;border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:920px}
    th,td{padding:10px;border-bottom:1px solid #22304e;text-align:right;vertical-align:top}
    th{background:#0b1220;color:#cfe0ff;position:sticky;top:0}
    .muted{opacity:.8}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.split{grid-template-columns:1fr 1fr}}
    .rightTools{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>

  <!-- QR Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- AES (CryptoJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <!-- QR decode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
</head>

<body>
<div class="wrap">
  <h1>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… QR Ù…Ø´ÙÙ‘Ø± (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± â€” LocalStorage)</h1>

  <div class="grid">

    <!-- LEFT: Generator + Scanner -->
    <div class="card">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ QR + Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h2>

      <div class="split">
        <div>
          <h3 style="margin:0 0 8px;font-size:15px" class="muted">A) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø¥Ù†Ø´Ø§Ø¡ QR</h3>

          <div class="row">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
              <input id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" />
            </div>
            <div>
              <label>ÙƒÙˆØ¯ / Ø±Ù‚Ù… Ø¬Ø§Ù…Ø¹ÙŠ</label>
              <input id="studentId" placeholder="Ù…Ø«Ø§Ù„: 20231234" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <input id="department" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø¸Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" />
            </div>
            <div>
              <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ / Ø§Ù„ÙØ±Ù‚Ø©</label>
              <input id="level" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©" />
            </div>
          </div>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="notes" placeholder="Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>

          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ØªØ´ÙÙŠØ± (AES)</label>
          <input id="passGen" type="password" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ©" />

          <div class="btns">
            <button id="btnMake">Ø¥Ù†Ø´Ø§Ø¡ QR Ù…Ø´ÙÙ‘Ø±</button>
            <button class="secondary" id="btnCopy">Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø´ÙÙ‘Ø±</button>
            <button class="secondary" id="btnDownload">ØªØ­Ù…ÙŠÙ„ QR (PNG)</button>
            <button class="danger" id="btnClearGen">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>

          <div class="qrbox" style="margin-top:14px">
            <div>
              <div class="pill">QR Output</div>
              <div id="qr" aria-label="QR code output"></div>
            </div>
            <div style="flex:1;min-width:260px">
              <div class="pill">Encrypted Payload</div>
              <div id="encOut" class="status mono small" style="word-break:break-all;min-height:90px">â€”</div>
              <div class="hint">
                Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ QR Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ÙÙŠØ±. Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡ Ù‚ØµÙŠØ±Ù‹Ø§ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù€ QR.
              </div>
            </div>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px;font-size:15px" class="muted">B) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© + Ø§Ù„Ù…Ø§Ø³Ø­</h3>

          <div class="row">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Course)</label>
              <input id="course" placeholder="Ù…Ø«Ø§Ù„: Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª" />
              <div class="hint">ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø­Ø¶ÙˆØ± Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</div>
            </div>
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø© (Session Date)</label>
              <input id="sessionDate" type="date" />
              <div class="hint">Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….</div>
            </div>
          </div>

          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± (Ù„Ø§Ø²Ù… Ù†ÙØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)</label>
          <input id="passScan" type="password" placeholder="Ø§ÙƒØªØ¨ Ù†ÙØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />

          <div class="btns">
            <button id="btnStartCam" class="ok">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button id="btnStopCam" class="secondary">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button id="btnManualDecrypt" class="secondary">ÙÙƒ ØªØ´ÙÙŠØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§</button>
          </div>

          <div style="margin-top:12px">
            <div class="pill">Camera Preview</div>
            <div class="status" style="padding:10px">
              <video id="video" playsinline style="width:100%;border-radius:12px;max-height:320px;background:#000"></video>
              <canvas id="canvas" style="display:none"></canvas>
              <div id="scanMsg" class="hint">Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ HTTPS/localhost).</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="pill">Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© (ÙÙƒ ØªØ´ÙÙŠØ± + ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±)</div>
            <div id="decStatus" class="status mono small" style="min-height:140px;white-space:pre-wrap">â€”</div>
          </div>

          <label style="margin-top:12px">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø´ÙÙ‘Ø± (Ù„Ù„ÙÙƒ Ø§Ù„ÙŠØ¯ÙˆÙŠ)</label>
          <textarea id="manualCipher" class="mono" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø´ÙÙ‘Ø± Ù‡Ù†Ø§..."></textarea>

          <div class="hint">
            âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© (file://). Ø§Ù„Ø£ÙØ¶Ù„ ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ø¨Ø±
            <span class="mono">localhost</span> Ø£Ùˆ <span class="mono">https</span>.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Attendance Table + Export -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <h2 style="margin:0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <div class="rightTools">
          <span class="pill" id="countPill">0 Ø³Ø¬Ù„</span>
          <button class="secondary" id="btnExport">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="danger" id="btnClearAttendance">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨ (ID) Ù„Ù†ÙØ³ <b>Course</b> ÙˆÙ†ÙØ³ <b>Session Date</b> Ù„Ù† ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø±ØªÙŠÙ†.
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Student ID</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
              <th>Course</th>
              <th>Session Date</th>
              <th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="attBody">
            <tr><td colspan="10" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hint" style="margin-top:12px">
        ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ <b>LocalStorage</b> Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­.
      </div>
    </div>

  </div>
</div>

<script>
  // -------------------- Storage --------------------
  const STORAGE_KEY = "qr_attendance_v1";

  function loadAttendance() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function saveAttendance(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  let attendance = loadAttendance();

  // -------------------- Helpers --------------------
  function setStatus(el, text, kind) {
    el.textContent = text;
    el.classList.remove("okBorder", "badBorder");
    if (kind === "ok") el.classList.add("okBorder");
    if (kind === "bad") el.classList.add("badBorder");
  }

  function nowISO() {
    const d = new Date();
    return d.toISOString();
  }

  function formatLocalDateTime(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString("ar-EG");
    } catch {
      return iso;
    }
  }

  function requiredField(value, msg) {
    if (!value || !value.trim()) throw new Error(msg);
    return value.trim();
  }

  function buildStudentPayload() {
    const payloadObj = {
      name: requiredField(studentName.value, "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨."),
      id: requiredField(studentId.value, "Ø§ÙƒØªØ¨ ÙƒÙˆØ¯/Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨."),
      department: (department.value || "").trim(),
      level: (level.value || "").trim(),
      notes: (notes.value || "").trim()
    };
    return payloadObj;
  }

  function encryptText(plain, pass) {
    return CryptoJS.AES.encrypt(plain, pass).toString();
  }

  function decryptText(cipher, pass) {
    const bytes = CryptoJS.AES.decrypt(cipher, pass);
    const plain = bytes.toString(CryptoJS.enc.Utf8);
    if (!plain) throw new Error("ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±. ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚Ø¯ ØªÙƒÙˆÙ† Ø®Ø§Ø·Ø¦Ø© Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
    return plain;
  }

  function safeJsonParse(s) {
    try { return { ok:true, value: JSON.parse(s) }; }
    catch(e){ return { ok:false, error:e }; }
  }

  function normalizeKey(s) {
    return (s || "").trim().toLowerCase();
  }

  function getCourse() {
    return requiredField(course.value, "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (Course) Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.");
  }

  function getSessionDate() {
    return requiredField(sessionDate.value, "Ø§Ø®ØªÙØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø© (Session Date).");
  }

  function getScanPass() {
    return requiredField(passScan.value, "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±.");
  }

  // -------------------- QR Generator --------------------
  let qrInstance = null;

  function renderQR(text) {
    qr.innerHTML = "";
    qrInstance = new QRCode(qr, {
      text,
      width: 220,
      height: 220,
      correctLevel: QRCode.CorrectLevel.M
    });
  }

  btnMake.addEventListener("click", () => {
    try {
      const pass = requiredField(passGen.value, "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ØªØ´ÙÙŠØ±.");
      const obj = buildStudentPayload();
      const plain = JSON.stringify(obj);
      const cipher = encryptText(plain, pass);

      renderQR(cipher);
      setStatus(encOut, cipher, "ok");
    } catch (e) {
      qr.innerHTML = "";
      setStatus(encOut, "âŒ " + e.message, "bad");
    }
  });

  btnCopy.addEventListener("click", async () => {
    const t = (encOut.textContent || "").trim();
    if (!t || t === "â€”") return;
    try {
      await navigator.clipboard.writeText(t);
      alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
    } catch {
      alert("Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
    }
  });

  function downloadQR() {
    const img = qr.querySelector("img");
    const cvs = qr.querySelector("canvas");
    let dataUrl = null;

    if (img && img.src) dataUrl = img.src;
    else if (cvs) dataUrl = cvs.toDataURL("image/png");

    if (!dataUrl) {
      alert("Ù…ÙÙŠØ´ QR Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„. Ø§Ø¹Ù…Ù„ Ø¥Ù†Ø´Ø§Ø¡ QR Ø§Ù„Ø£ÙˆÙ„.");
      return;
    }

    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = "student-qr.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  btnDownload.addEventListener("click", downloadQR);

  btnClearGen.addEventListener("click", () => {
    [studentName, studentId, department, level, notes, passGen].forEach(i => i.value = "");
    qr.innerHTML = "";
    encOut.textContent = "â€”";
    encOut.classList.remove("okBorder","badBorder");
  });

  // -------------------- Attendance Logic --------------------
  function buildAttendanceKey(studentId, courseName, sessDate) {
    // Unique per student + course + session date
    return `${normalizeKey(studentId)}|${normalizeKey(courseName)}|${normalizeKey(sessDate)}`;
  }

  function isDuplicate(studentId, courseName, sessDate) {
    const key = buildAttendanceKey(studentId, courseName, sessDate);
    return attendance.some(r => r.key === key);
  }

  function addAttendanceRecord(studentObj) {
    const c = getCourse();
    const sd = getSessionDate();

    if (isDuplicate(studentObj.id, c, sd)) {
      setStatus(decStatus,
        `âš ï¸ ØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±\n\nØ§Ù„Ø·Ø§Ù„Ø¨: ${studentObj.name}\nID: ${studentObj.id}\nCourse: ${c}\nSession Date: ${sd}\n\nÙ‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®.`,
        "bad"
      );
      return false;
    }

    const rec = {
      key: buildAttendanceKey(studentObj.id, c, sd),
      studentId: studentObj.id || "",
      name: studentObj.name || "",
      department: studentObj.department || "",
      level: studentObj.level || "",
      notes: studentObj.notes || "",
      course: c,
      sessionDate: sd,
      recordedAtISO: nowISO()
    };

    attendance.unshift(rec);
    saveAttendance(attendance);
    renderAttendanceTable();

    setStatus(decStatus,
      `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­\n\nØ§Ù„Ø§Ø³Ù…: ${rec.name}\nID: ${rec.studentId}\nØ§Ù„Ù‚Ø³Ù…: ${rec.department}\nØ§Ù„Ù…Ø³ØªÙˆÙ‰: ${rec.level}\nCourse: ${rec.course}\nSession Date: ${rec.sessionDate}\nÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${formatLocalDateTime(rec.recordedAtISO)}\n\n(ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ LocalStorage)`,
      "ok"
    );

    return true;
  }

  function removeAttendanceAt(index) {
    attendance.splice(index, 1);
    saveAttendance(attendance);
    renderAttendanceTable();
  }

  function escapeCsv(value) {
    const s = String(value ?? "");
    // Escape quotes by doubling them
    const escaped = s.replace(/"/g, '""');
    // Wrap if contains comma/newline/quote
    if (/[",\n\r]/.test(escaped)) return `"${escaped}"`;
    return escaped;
  }

  function exportCSV() {
    if (!attendance.length) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
      return;
    }

    const headers = [
      "#",
      "studentId",
      "name",
      "department",
      "level",
      "course",
      "sessionDate",
      "recordedAt",
      "notes"
    ];

    const rows = attendance.map((r, i) => ([
      i + 1,
      r.studentId,
      r.name,
      r.department,
      r.level,
      r.course,
      r.sessionDate,
      formatLocalDateTime(r.recordedAtISO),
      r.notes
    ]));

    const csv = [
      headers.map(escapeCsv).join(","),
      ...rows.map(row => row.map(escapeCsv).join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `attendance_${(course.value||"course").replace(/\s+/g,'_')}_${(sessionDate.value||"date")}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  btnExport.addEventListener("click", exportCSV);

  btnClearAttendance.addEventListener("click", () => {
    if (!confirm("Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.")) return;
    attendance = [];
    saveAttendance(attendance);
    renderAttendanceTable();
    setStatus(decStatus, "ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.", "ok");
  });

  function renderAttendanceTable() {
    countPill.textContent = `${attendance.length} Ø³Ø¬Ù„`;
    if (!attendance.length) {
      attBody.innerHTML = `<tr><td colspan="10" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;
      return;
    }

    attBody.innerHTML = attendance.map((r, idx) => `
      <tr>
        <td>${idx + 1}</td>
        <td class="mono">${r.studentId}</td>
        <td>${r.name}</td>
        <td>${r.department}</td>
        <td>${r.level}</td>
        <td>${r.course}</td>
        <td class="mono">${r.sessionDate}</td>
        <td>${formatLocalDateTime(r.recordedAtISO)}</td>
        <td>${(r.notes || "").replace(/</g,"&lt;")}</td>
        <td>
          <button class="danger" data-del="${idx}" style="padding:8px 10px;border-radius:10px;font-weight:700">Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join("");

    attBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        removeAttendanceAt(i);
      });
    });
  }

  // -------------------- Scanner (Camera + jsQR) --------------------
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });
  let stream = null;
  let scanning = false;
  let rafId = null;
  let lastScannedCipher = null;
  let lastScanAt = 0;

  async function startCam() {
    if (stream) { scanning = true; scanLoop(); return; }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      scanLoop();
      scanMsg.textContent = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„â€¦ ÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ù†Ø­Ùˆ QR.";
    } catch (e) {
      scanMsg.textContent =
        "âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS Ø£Ùˆ localhost.";
    }
  }

  function stopCam() {
    scanning = false;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    scanMsg.textContent = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.";
  }

  function handleCipher(cipherText) {
    try {
      const pass = getScanPass();
      const plain = decryptText(cipherText, pass);

      const parsed = safeJsonParse(plain);
      if (!parsed.ok) throw new Error("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ù„ÙŠØ³Øª JSON ØµØ­ÙŠØ­.");

      const studentObj = parsed.value;

      // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
      if (!studentObj || !studentObj.id || !studentObj.name) {
        throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ QR.");
      }

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
      addAttendanceRecord(studentObj);

    } catch (e) {
      setStatus(decStatus, "âŒ " + e.message, "bad");
    }
  }

  function scanLoop() {
    if (!scanning) return;

    if (!video.videoWidth) {
      rafId = requestAnimationFrame(scanLoop);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "dontInvert"
    });

    if (code && code.data) {
      // throttle to prevent repeated reads of same QR
      const now = Date.now();
      const same = (code.data === lastScannedCipher);
      const tooSoon = (now - lastScanAt) < 2500;

      if (!same || !tooSoon) {
        lastScannedCipher = code.data;
        lastScanAt = now;
        scanMsg.textContent = "ğŸ“Œ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· QRâ€¦ Ø¬Ø§Ø±ÙŠ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.";
        handleCipher(code.data);
      } else {
        scanMsg.textContent = "ğŸ” ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ù†ÙØ³ Ø§Ù„Ù€ QR Ù…Ø¤Ø®Ø±Ù‹Ø§â€¦";
      }
    } else {
      scanMsg.textContent = "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† QRâ€¦";
    }

    rafId = requestAnimationFrame(scanLoop);
  }

  btnStartCam.addEventListener("click", startCam);
  btnStopCam.addEventListener("click", stopCam);

  btnManualDecrypt.addEventListener("click", () => {
    const cipher = (manualCipher.value || "").trim();
    if (!cipher) return setStatus(decStatus, "Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø´ÙÙ‘Ø± Ø£ÙˆÙ„Ù‹Ø§.", "bad");
    handleCipher(cipher);
  });

  // -------------------- Init --------------------
  function initDefaults() {
    // default session date to today
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    sessionDate.value = `${yyyy}-${mm}-${dd}`;
  }

  window.addEventListener("load", async () => {
    initDefaults();
    renderAttendanceTable();

    // Auto-start camera
    await startCam();

    // if browser blocked auto-start
    if (!stream) {
      scanMsg.textContent =
        "âš ï¸ Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ø¶ØºØ· â€œØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€. ÙˆØªØ£ÙƒØ¯ Ù…Ù† HTTPS/localhost.";
    }
  });
</script>
</body>
</html>
